# 七牛云迁移说明

## 概述

本项目已从 DeepSeek 迁移到七牛云 AI 服务，用于事件数据的查询和验证。七牛云提供更准确的数据，并通过双重验证机制有效防止幻觉数据进入数据库。

## 主要改进

### 1. **数据源切换**
- **之前**: 使用 DeepSeek API 查询事件数据
- **现在**: 使用七牛云 AI (Claude Sonnet 4) 查询事件数据

### 2. **双重验证机制**
系统现在采用两阶段验证流程：

#### 阶段 1: 数据查询
- 调用七牛云 AI 获取指定城市和日期的事件数据
- 使用极低温度 (0.1) 减少幻觉
- 要求 AI 基于真实可靠的公开信息源

#### 阶段 2: 数据验证
- 对每个查询到的事件，再次调用七牛云 AI 进行事实核查
- 验证事件是否真实存在于公开渠道
- 只有通过验证的事件才会被写入数据库
- 支持重试机制和限流处理

### 3. **数据流程**

```
查询请求 
  ↓
七牛云 AI 查询 (temperature=0.1)
  ↓
Schema 验证 (Zod)
  ↓
七牛云 AI 逐条验证 (temperature=0)
  ↓
通过验证的事件
  ↓
写入数据库 (基于 hash 去重)
```

## 配置说明

### 环境变量

在 `.env` 文件中添加以下配置：

```bash
# 七牛云 AI (用于查询和验证)
QINIU_ENDPOINT=https://api.qnaigc.com/v1
QINIU_MODEL=claude-sonnet-4-20250514
QINIU_API_KEY=your_qiniu_api_key_here
```

### 获取七牛云 API Key

1. 访问 [七牛云官网](https://www.qiniu.com/)
2. 注册并登录账号
3. 进入控制台 → AI 服务
4. 创建 API Key
5. 将 API Key 复制到 `.env` 文件中

## 验证机制详解

### 验证提示词

系统会构建详细的验证提示词，包含：
- 城市
- 事件标题
- 事件类型 (expo/concert)
- 场馆
- 地址
- 开始/结束日期
- 来源链接
- 主办方

### 验证响应格式

```json
{
  "verified": true/false,
  "confidence": 0.95,
  "reason": "在官方网站找到该活动的公开信息"
}
```

### 验证策略

- **重试机制**: 最多重试 3 次
- **限流处理**: 遇到 429 错误时使用指数退避
- **保守策略**: 无法解析验证结果时，默认拒绝该事件

## API 接口

### 手动同步事件

```bash
POST /events/sync?city=杭州
```

该接口会：
1. 调用七牛云 AI 获取事件数据
2. 使用七牛云进行逐条验证
3. 将验证通过的事件写入数据库
4. 返回同步结果统计

### 定时任务

系统每天 18:00 (UTC+8) 自动执行同步任务：
- 获取未来 30 天的事件数据
- 自动验证并入库
- 记录详细日志

## 性能考虑

### 验证成本
- 每个事件需要 2 次 API 调用（1 次查询 + 1 次验证）
- 建议合理设置查询范围，避免过多 API 调用

### 优化建议
1. **批量查询**: 一次查询获取多个事件
2. **缓存机制**: 对已验证的事件进行缓存（未实现）
3. **异步验证**: 验证过程已经是异步的，不会阻塞主流程

## 日志说明

系统会记录详细的日志信息：

```
🔍 开始从七牛云获取 杭州 在 2025-12-03 的事件信息
✅ 成功获取并验证了 5 个有效事件
❌ 七牛云验证未通过，跳过事件: 某虚假活动
⚠️  共有 2 个事件未通过七牛云验证
```

## 向后兼容

- DeepSeek 相关代码已标记为"已弃用"但保留
- 可以通过修改代码切换回 DeepSeek（不推荐）
- 数据库结构无变化，完全兼容

## 故障排查

### 问题: 没有获取到任何事件

**可能原因**:
1. 七牛云 API Key 未配置或无效
2. API 调用失败（网络问题）
3. 所有事件都未通过验证

**解决方法**:
1. 检查 `.env` 文件中的 `QINIU_API_KEY`
2. 查看日志中的错误信息
3. 确认七牛云账户余额充足

### 问题: 验证通过率很低

**可能原因**:
1. 查询到的事件本身就是幻觉数据
2. 验证提示词需要优化
3. 七牛云 AI 过于保守

**解决方法**:
1. 调整查询提示词，要求更准确的信息
2. 降低验证的严格程度（需修改代码）
3. 检查具体被拒绝的事件，分析原因

### 问题: API 限流 (429 错误)

**可能原因**:
- 短时间内调用次数过多

**解决方法**:
- 系统已内置重试机制，会自动处理
- 如果频繁出现，考虑增加请求间隔
- 升级七牛云账户的 API 限额

## 技术栈

- **后端框架**: NestJS
- **AI 服务**: 七牛云 AI (Claude Sonnet 4)
- **数据验证**: Zod
- **数据库**: MySQL + TypeORM
- **定时任务**: @nestjs/schedule

## 相关文件

- `backend/src/deepseek/deepseek.service.ts` - 核心服务（已重命名但保留文件名）
- `backend/src/events/events.controller.ts` - 事件同步接口
- `backend/src/scheduler/tasks.service.ts` - 定时任务
- `backend/.env` - 环境配置

## 下一步优化

1. **缓存机制**: 对已验证的事件进行缓存，避免重复验证
2. **批量验证**: 一次 API 调用验证多个事件
3. **置信度阈值**: 根据验证置信度决定是否入库
4. **人工审核**: 对低置信度事件进行人工审核
5. **数据源多样化**: 结合多个 AI 服务进行交叉验证
