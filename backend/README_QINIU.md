# 七牛云集成快速指南

## 🎯 核心改进

项目已成功从 DeepSeek 迁移到七牛云 AI，实现了**查询 + 验证**的双重保障机制，有效防止幻觉数据进入数据库。

## ⚡ 快速开始

### 1. 配置环境变量

编辑 `backend/.env` 文件，添加七牛云配置：

```bash
# 七牛云 AI (用于查询和验证)
QINIU_ENDPOINT=https://api.qnaigc.com/v1
QINIU_MODEL=claude-sonnet-4-20250514
QINIU_API_KEY=你的七牛云API密钥
```

### 2. 获取 API Key

1. 访问 https://www.qiniu.com/
2. 注册并登录
3. 进入 AI 服务控制台
4. 创建 API Key
5. 复制到 `.env` 文件

### 3. 启动服务

```bash
cd backend
npm install
npm run start:dev
```

## 🔄 数据流程

```
用户请求
   ↓
七牛云查询事件 (temperature=0.1, 减少幻觉)
   ↓
Schema验证 (Zod)
   ↓
七牛云逐条验证 (temperature=0, 事实核查)
   ↓
✅ 验证通过 → 写入数据库
❌ 验证失败 → 丢弃数据
```

## 📊 验证机制

### 验证内容
- 事件是否真实存在
- 是否可在公开渠道查证
- 信息是否准确可靠

### 验证策略
- **重试**: 最多 3 次
- **限流处理**: 自动指数退避
- **保守原则**: 无法确认时拒绝

## 🚀 使用接口

### 手动同步

```bash
curl -X POST "http://localhost:3000/events/sync?city=杭州"
```

### 自动同步

系统每天 18:00 自动同步未来 30 天的事件数据。

## 📝 日志示例

```
🔍 开始从七牛云获取 杭州 在 2025-12-03 的事件信息
✅ 成功获取并验证了 5 个有效事件
❌ 七牛云验证未通过，跳过事件: 某虚假活动
⚠️  共有 2 个事件未通过七牛云验证
```

## ⚠️ 注意事项

1. **API 成本**: 每个事件需要 2 次 API 调用（查询 + 验证）
2. **验证时间**: 验证过程可能需要几秒钟
3. **限流**: 注意七牛云 API 的调用限制
4. **准确率**: 验证机制可能拒绝部分真实事件（保守策略）

## 🔧 故障排查

### 没有获取到事件？
1. 检查 `QINIU_API_KEY` 是否正确配置
2. 查看日志中的错误信息
3. 确认七牛云账户余额

### 验证通过率低？
1. 查询到的数据本身可能不准确
2. 可以调整验证提示词
3. 检查被拒绝事件的具体原因

### 遇到 429 错误？
- 系统已内置重试机制
- 如频繁出现，考虑升级 API 限额

## 📚 详细文档

查看项目根目录的 `QINIU_MIGRATION.md` 了解更多技术细节。

## 🎉 优势总结

✅ **更准确**: 使用 Claude Sonnet 4 模型，准确率更高  
✅ **防幻觉**: 双重验证机制，有效过滤虚假数据  
✅ **可靠性**: 重试机制和限流处理，保证稳定性  
✅ **可追溯**: 详细日志记录，便于问题排查  
